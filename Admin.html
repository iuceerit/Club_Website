<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Admin Panel</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Loader Animation */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom Scrollbar for Webkit */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #111827;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        /* Toast Slide Animation */
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Input Styles */
        .input-field {
            width: 100%;
            background-color: #1f2937;
            /* gray-800 */
            border: 1px solid #374151;
            /* gray-700 */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .input-field::placeholder {
            color: #9ca3af;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 font-sans antialiased selection:bg-blue-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createClient } = window.supabase;

        // ==========================================
        // CONFIGURATION & CONSTANTS
        // ==========================================
        const BUCKET_NAME = 'site_assets';

        /**
         * Maps UI view names to Supabase table names.
         * keys: View ID used in the UI state.
         * values: Actual table name in the database.
         */
        const TABLE_MAP = {
            projects: 'projects',
            events: 'events',
            timeline: 'timeline_events',
            achievements: 'achievements',
            partners: 'partners',
            team: 'team_members',
            alumni: 'alumni',
            gallery: 'gallery_albums',
            applications: 'applications'
        };

        /**
         * List of views that support drag-and-drop reordering.
         */
        const ORDERABLE_VIEWS = ['projects', 'events', 'timeline', 'achievements', 'partners', 'team', 'alumni'];

        // ==========================================
        // UTILITY COMPONENTS
        // ==========================================

        /**
         * Renders a Lucide icon safely in the browser.
         */
        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (!window.lucide || !containerRef.current) return;
                const container = containerRef.current;
                container.innerHTML = '';

                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                if (className) i.className = className;
                container.appendChild(i);

                window.lucide.createIcons({
                    root: container,
                    nameAttr: 'data-lucide',
                    attrs: { width: size, height: size }
                });
            }, [name, size, className]);

            return <span ref={containerRef} style={{ display: 'inline-flex' }}></span>;
        };

        /**
         * A simple loading spinner.
         */
        const Loader = () => <div className="loader"></div>;

        /**
         * Helper button for file inputs to trigger hidden file selection.
         */
        const FileUploadButton = ({ onFileSelect }) => {
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const previewUrl = URL.createObjectURL(file);
                onFileSelect(file, previewUrl);
            };

            return (
                <div className="relative group inline-block">
                    <input type="file" onChange={handleFileChange} accept="image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                    <button type="button" className="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-2 rounded border border-gray-700 flex items-center gap-2 transition">
                        <Icon name="upload" size={16} />
                        <span className="text-sm font-medium">Select File</span>
                    </button>
                </div>
            );
        };

        // ==========================================
        // FEATURE: AUTHENTICATION
        // ==========================================

        const Login = ({ onLogin }) => {
            const [url, setUrl] = useState('');
            const [key, setKey] = useState('');
            const [loading, setLoading] = useState(false);

            // Pre-fill URL if available in environment or previous session logic
            useEffect(() => {
                setUrl('https://qmjwyqbqlttwfchhbcjd.supabase.co');
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                // Simulate a small delay for better UX or validate connection here
                await onLogin(url, key);
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-950 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-900/20 via-gray-950 to-gray-950"></div>
                    <div className="bg-gray-900/80 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-800 backdrop-blur-sm z-10">
                        <div className="text-center mb-8">
                            <h2 className="text-2xl font-bold text-white">Admin Access</h2>
                            <p className="text-gray-500 text-sm mt-2">Connect to your Supabase instance</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="text-xs text-gray-500 mb-1 block uppercase font-semibold">Supabase URL</label>
                                <input type="text" value={url} onChange={e => setUrl(e.target.value)} className="input-field text-gray-400" readOnly />
                            </div>
                            <div>
                                <label className="text-xs text-gray-500 mb-1 block uppercase font-semibold">Service Role Key</label>
                                <input type="password" value={key} onChange={e => setKey(e.target.value)} className="input-field" placeholder="Paste Key Here" required />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2 transition-all shadow-lg shadow-blue-900/20">
                                {loading ? <Loader /> : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // ==========================================
        // FEATURE: MEDIA MANAGER
        // ==========================================

        /**
         * Advanced media manager for uploading multiple images/videos for a specific entity.
         */
        const MediaManager = ({ entityType, entityId, supabase, items, onItemsChange, onDeletedIdsChange }) => {
            const [isDraggingFile, setIsDraggingFile] = useState(false);
            const [loading, setLoading] = useState(false);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            const [videoUrl, setVideoUrl] = useState('');

            // Fetch existing media when opening
            useEffect(() => {
                if (!entityId || items.length > 0) return;

                const fetchMedia = async () => {
                    setLoading(true);
                    const { data } = await supabase.from('media_gallery')
                        .select('*')
                        .eq('entity_type', entityType)
                        .eq('entity_id', entityId)
                        .order('is_primary', { ascending: false })
                        .order('id', { ascending: false });

                    if (data) {
                        const mapped = data.map(d => ({ ...d, media_type: d.media_type || 'IMAGE' }));
                        onItemsChange(mapped);
                    }
                    setLoading(false);
                };
                fetchMedia();
            }, [entityId, entityType, supabase]);

            // Handlers
            const handleFiles = (files) => {
                const newItems = Array.from(files).map(file => ({
                    image_url: URL.createObjectURL(file),
                    file: file,
                    is_primary: false,
                    is_new: true,
                    media_type: 'IMAGE'
                }));
                // If list was empty, first one is primary (cover)
                if (items.length === 0 && newItems.length > 0) newItems[0].is_primary = true;
                onItemsChange([...items, ...newItems]);
            };

            const handleAddVideo = () => {
                if (!videoUrl) return;
                const newItem = {
                    image_url: videoUrl,
                    media_type: 'VIDEO',
                    is_primary: items.length === 0,
                    is_new: true
                };
                onItemsChange([...items, newItem]);
                setVideoUrl('');
            };

            const togglePrimary = (indexToSet) => {
                const updated = items.map((item, idx) => ({ ...item, is_primary: idx === indexToSet }));
                onItemsChange(updated);
            };

            const handleDelete = (indexToDelete) => {
                const item = items[indexToDelete];
                if (item.id) onDeletedIdsChange(item.id); // Track ID to delete from DB later
                const updated = items.filter((_, idx) => idx !== indexToDelete);
                onItemsChange(updated);
            };

            // Drag & Drop for reordering media
            const handleDragStart = (e, index) => { setDraggedItemIndex(index); e.dataTransfer.effectAllowed = "move"; };
            const handleDragOver = (e, index) => { e.preventDefault(); };
            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedItemIndex === null) return;
                const newItems = [...items];
                const [movedItem] = newItems.splice(draggedItemIndex, 1);
                newItems.splice(dropIndex, 0, movedItem);
                onItemsChange(newItems);
                setDraggedItemIndex(null);
            };

            const renderPreview = (item) => {
                if (item.media_type === 'VIDEO') {
                    // Try to generate thumbnail from YouTube/Instagram
                    let thumb = 'https://placehold.co/600x400?text=Video';
                    const ytMatch = item.image_url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                    if (ytMatch && ytMatch[2].length === 11) {
                        thumb = `https://img.youtube.com/vi/${ytMatch[2]}/0.jpg`;
                    }
                    if (item.image_url.includes('instagram.com')) {
                        thumb = 'https://placehold.co/600x400/E1306C/FFFFFF?text=Instagram';
                    }
                    return (
                        <div className="w-full h-full relative group-inner bg-black">
                            <img src={thumb} className="w-full h-full object-cover pointer-events-none opacity-80" alt="Video thumbnail" />
                            <div className="absolute inset-0 flex items-center justify-center">
                                <Icon name="play-circle" size={32} className="text-white" />
                            </div>
                        </div>
                    );
                }
                return <img src={item.image_url} className="w-full h-full object-cover pointer-events-none" alt="Preview" />;
            };

            return (
                <div className="mt-8 pt-6 border-t border-gray-800">
                    <h4 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <Icon name="image" className="text-blue-500" /> Media Gallery
                    </h4>

                    {/* Add Media Controls */}
                    <div className="flex gap-2 mb-4">
                        <input type="text" value={videoUrl} onChange={(e) => setVideoUrl(e.target.value)} placeholder="Paste YouTube or Instagram Link..." className="input-field" />
                        <button type="button" onClick={handleAddVideo} className="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded font-bold whitespace-nowrap transition">
                            Add Video
                        </button>
                    </div>

                    {/* Drop Zone */}
                    <div
                        onDragOver={(e) => { e.preventDefault(); setIsDraggingFile(true); }}
                        onDragLeave={() => setIsDraggingFile(false)}
                        onDrop={(e) => { e.preventDefault(); setIsDraggingFile(false); if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); }}
                        className={`relative border-2 border-dashed rounded-xl p-6 text-center transition-all mb-6 flex flex-col items-center justify-center gap-3 cursor-pointer ${isDraggingFile ? 'border-blue-500 bg-blue-900/10' : 'border-gray-700 bg-gray-900/50 hover:bg-gray-800'}`}
                    >
                        <input type="file" multiple onChange={(e) => handleFiles(e.target.files)} accept="image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        {loading ? <Loader /> : <>
                            <Icon name="upload-cloud" size={32} className="text-gray-500" />
                            <div className="text-sm text-gray-300">Click or drag and drop images here</div>
                        </>}
                    </div>

                    {/* Grid of Media Items */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {items.map((img, idx) => (
                            <div key={idx} draggable onDragStart={(e) => handleDragStart(e, idx)} onDragOver={(e) => handleDragOver(e, idx)} onDrop={(e) => handleDrop(e, idx)}
                                className={`group relative aspect-video rounded-lg overflow-hidden border-2 cursor-move transition-transform ${img.is_primary ? 'border-green-500' : 'border-gray-800'} ${draggedItemIndex === idx ? 'opacity-50 scale-95 border-dashed border-blue-500' : ''}`}
                            >
                                {renderPreview(img)}

                                {img.is_new && <div className="absolute top-2 right-2 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow">NEW</div>}
                                {img.is_primary && <div className="absolute top-2 left-2 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow">COVER</div>}

                                <div className="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 p-2">
                                    <div className="text-white text-xs mb-1 flex items-center gap-1"><Icon name="move" size={12} /> Drag</div>
                                    {!img.is_primary && <button type="button" onClick={() => togglePrimary(idx)} className="bg-white text-black px-3 py-1 rounded text-xs font-bold w-full hover:bg-gray-200">Set Cover</button>}
                                    <button type="button" onClick={() => handleDelete(idx)} className="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold w-full hover:bg-red-500">Remove</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // FEATURE: REORDER MODAL
        // ==========================================

        const ReorderModal = ({ isOpen, onClose, items, onSave, title }) => {
            const [list, setList] = useState(items);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            const [saving, setSaving] = useState(false);

            useEffect(() => { setList(items); }, [items]);

            const handleDragStart = (e, index) => { setDraggedItemIndex(index); e.dataTransfer.effectAllowed = "move"; };
            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedItemIndex === null) return;
                const newList = [...list];
                const [movedItem] = newList.splice(draggedItemIndex, 1);
                newList.splice(dropIndex, 0, movedItem);
                setList(newList);
                setDraggedItemIndex(null);
            };

            const handleSave = async () => {
                setSaving(true);
                await onSave(list);
                setSaving(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-gray-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-gray-800">
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900">
                            <h3 className="text-xl font-bold text-white">Reorder {title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white"><Icon name="x" /></button>
                        </div>
                        <div className="p-4 bg-gray-800/50 text-xs text-gray-400 text-center border-b border-gray-800">
                            Drag and drop items to reorder. The order here will be reflected on the website.
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar bg-gray-900/50 flex-1">
                            <div className="space-y-2">
                                {list.map((item, idx) => (
                                    <div key={item.id} draggable onDragStart={(e) => handleDragStart(e, idx)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, idx)}
                                        className={`bg-gray-800 p-3 rounded border border-gray-700 flex items-center gap-4 cursor-move hover:bg-gray-700 transition ${draggedItemIndex === idx ? 'opacity-50 border-blue-500' : ''}`}
                                    >
                                        <div className="text-gray-500"><Icon name="grip-vertical" size={16} /></div>
                                        {item.image_url && <img src={item.image_url} className="w-10 h-10 rounded object-cover bg-gray-700" />}
                                        <div className="flex-1 font-medium text-gray-200">{item.title || item.name || 'Untitled'}</div>
                                        <div className="text-xs text-gray-500 font-mono">#{idx + 1}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="p-5 border-t border-gray-800 flex justify-end bg-gray-900">
                            <button onClick={handleSave} disabled={saving} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                {saving ? <Loader /> : <Icon name="check" size={18} />}
                                {saving ? 'Saving...' : 'Save Order'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // FEATURE: DASHBOARD COMPONENTS
        // ==========================================

        const Dashboard = ({ stats, enrollmentStatus, onToggleEnrollment }) => {
            const statItems = [
                { label: 'Total Projects', val: stats.projects, icon: 'folder', color: 'text-blue-500' },
                { label: 'Events Hosted', val: stats.events, icon: 'calendar', color: 'text-purple-500' },
                { label: 'Active Members', val: stats.team_members, icon: 'users', color: 'text-green-500' },
                { label: 'Applications', val: stats.applications, icon: 'file-text', color: 'text-yellow-500' }
            ];

            return (
                <div className="space-y-8 animate-fade-in">
                    {/* Enrollment Control Card */}
                    <div className="bg-gray-900 p-8 rounded-2xl border border-gray-800 flex flex-col md:flex-row items-center justify-between gap-6 shadow-xl">
                        <div>
                            <h3 className="text-2xl font-bold text-white mb-2">Enrollment Status</h3>
                            <p className="text-gray-400">Controls the visibility of the "Join Chapter" buttons.</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className={`px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${enrollmentStatus ? 'bg-green-900 text-green-300 border border-green-700' : 'bg-red-900 text-red-300 border border-red-700'}`}>
                                {enrollmentStatus ? 'Active' : 'Closed'}
                            </div>
                            <button onClick={onToggleEnrollment} className={`px-6 py-3 rounded-xl font-bold transition-all shadow-lg hover:scale-105 active:scale-95 ${enrollmentStatus ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-green-600 hover:bg-green-500 text-white'}`}>
                                {enrollmentStatus ? 'Stop Enrollment' : 'Start Enrollment'}
                            </button>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {statItems.map((stat, i) => (
                            <div key={i} className="bg-gray-900 p-6 rounded-xl border border-gray-800 hover:border-gray-700 transition hover:translate-y-[-2px] shadow-lg">
                                <div className="flex justify-between items-start mb-4">
                                    <div className={`p-3 rounded-lg bg-gray-800 ${stat.color}`}>
                                        <Icon name={stat.icon} size={24} />
                                    </div>
                                    <span className="text-3xl font-bold text-white">{stat.val || 0}</span>
                                </div>
                                <div className="text-sm text-gray-400 font-medium">{stat.label}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // FEATURE: DATA TABLE & EDIT FORM
        // ==========================================

        const DataTable = ({ columns, data, onEdit, onDelete }) => (
            <div className="overflow-x-auto rounded-lg border border-gray-800 shadow-lg">
                <table className="min-w-full bg-gray-900">
                    <thead className="bg-gray-950 text-gray-400 uppercase text-xs font-semibold tracking-wider">
                        <tr>
                            {columns.map(col => <th key={col.key} className="px-6 py-4 text-left">{col.label}</th>)}
                            <th className="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-800">
                        {data.length === 0 ? (
                            <tr><td colSpan={columns.length + 1} className="px-6 py-12 text-center text-gray-500">No records found.</td></tr>
                        ) : (
                            data.map((item) => (
                                <tr key={item.id} className="hover:bg-gray-800/50 transition-colors group">
                                    {columns.map(col => (
                                        <td key={col.key} className="px-6 py-4 text-sm text-gray-300 align-middle">
                                            {col.type === 'image' ? (
                                                item[col.key] ? <img src={item[col.key]} className="h-10 w-10 rounded object-cover border border-gray-700 bg-white" alt="Thumb" /> : <div className="h-10 w-10 bg-gray-800 rounded flex items-center justify-center text-gray-600"><Icon name="image" size={14} /></div>
                                            ) : col.type === 'link' ? (
                                                item[col.key] ? <a href={item[col.key]} target="_blank" className="text-blue-400 hover:underline flex items-center gap-1">Link <Icon name="external-link" size={10} /></a> : '-'
                                            ) : col.type === 'bool' ? (
                                                item[col.key] ? <span className="text-green-400 bg-green-400/10 px-2 py-0.5 rounded text-xs font-bold">Yes</span> : <span className="text-red-400 bg-red-400/10 px-2 py-0.5 rounded text-xs font-bold">No</span>
                                            ) : col.type === 'array' ? (
                                                <div className="flex gap-1 flex-wrap">{item[col.key]?.map(tag => <span key={tag} className="px-1.5 py-0.5 bg-gray-800 rounded text-[10px] border border-gray-700">{tag}</span>) || '-'}</div>
                                            ) : (
                                                <div className="max-w-xs truncate" title={item[col.key]}>{item[col.key] || '-'}</div>
                                            )}
                                        </td>
                                    ))}
                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                                        <div className="flex justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                            {onEdit && <button onClick={() => onEdit(item)} className="p-1.5 text-blue-400 hover:text-white hover:bg-blue-600 rounded transition"><Icon name="edit-3" size={16} /></button>}
                                            {onDelete && <button onClick={(e) => { e.stopPropagation(); onDelete(item.id); }} className="p-1.5 text-red-400 hover:text-white hover:bg-red-600 rounded transition"><Icon name="trash-2" size={16} /></button>}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        );

        /**
         * Extracted Form Fields logic to separate file clutter from logic.
         * Renders different inputs based on the 'view' type.
         */
        const FormFields = ({ view, formData, onChange, onFileSelect }) => {
            // Reusable Input Helper
            const Field = ({ label, name, placeholder, required = false, type = "text", className = "" }) => (
                <div className={className}>
                    {label && <label className="text-xs text-gray-500 mb-1 block">{label}</label>}
                    <input name={name} value={formData[name] || ''} onChange={e => onChange(name, e.target.value)} placeholder={placeholder} className="input-field" required={required} type={type} />
                </div>
            );

            // Reusable Image Upload Helper
            const ImageUpload = ({ name, label }) => (
                <div className="bg-gray-800 p-4 rounded border border-gray-700 mt-2">
                    <label className="text-sm text-gray-400 mb-2 block">{label}</label>
                    <div className="flex gap-4 items-center">
                        <div className="w-12 h-12 bg-gray-700 rounded-full overflow-hidden border border-gray-600 flex-shrink-0">
                            {formData[name] ? <img src={formData[name]} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><Icon name="user" /></div>}
                        </div>
                        <div className="flex-1">
                            <input name={name} value={formData[name] || ''} onChange={e => onChange(name, e.target.value)} placeholder="Paste URL or Upload ->" className="input-field mb-2" />
                            <FileUploadButton onFileSelect={(file, url) => onFileSelect(name, file, url)} />
                        </div>
                    </div>
                </div>
            );

            // Render specific fields based on view
            switch (view) {
                case 'projects':
                    return (
                        <>
                            <Field name="title" placeholder="Project Title" required />
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="category" placeholder="Category" />
                                <Field name="status" placeholder="Status" />
                            </div>
                            <textarea name="description" value={formData.description || ''} onChange={e => onChange('description', e.target.value)} placeholder="Description" className="input-field h-24" />
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="technologies" label="Tech Stack (comma separated)" />
                                <Field name="contributors" label="Contributors (comma separated)" />
                            </div>
                            <Field name="github_url" placeholder="GitHub URL" />
                        </>
                    );
                case 'team':
                    return (
                        <>
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="name" placeholder="Full Name" required />
                                <Field name="team_role" placeholder="Role" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="department" placeholder="Department" />
                                <Field name="bio" placeholder="Short Bio" />
                            </div>
                            <Field name="linkedin_url" placeholder="LinkedIn URL" />
                            {/* FIXED: Static / Leadership Checkbox */}
                            <div className="flex items-center gap-3 bg-gray-800 p-3 rounded mt-2">
                                <input
                                    type="checkbox"
                                    name="is_static"
                                    checked={formData.is_static || false}
                                    onChange={e => onChange('is_static', e.target.checked)}
                                    className="w-5 h-5 accent-purple-600"
                                />
                                <label className="text-sm text-gray-300">Static / Leadership (Main Figure)</label>
                            </div>

                            <ImageUpload name="image_url" label="Profile Photo" />
                        </>
                    );
                case 'alumni':
                    return (
                        <>
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="name" placeholder="Alumni Name" required />
                                <Field name="graduation_year" placeholder="Graduation Year (e.g. 2023)" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="job_title" placeholder="Current Job Title" />
                                <Field name="linkedin_url" placeholder="LinkedIn URL" />
                            </div>
                            <textarea name="quote" value={formData.quote || ''} onChange={e => onChange('quote', e.target.value)} placeholder="Alumni Quote" className="input-field h-24" />
                            <ImageUpload name="image_url" label="Profile Photo" />
                        </>
                    );
                case 'gallery':
                    return (
                        <>
                            <Field name="title" placeholder="Album Title" required />
                            <Field name="event_date" type="date" />
                            <textarea name="description" value={formData.description || ''} onChange={e => onChange('description', e.target.value)} placeholder="Album Description" className="input-field h-24" />
                        </>
                    );
                case 'timeline':
                    return (
                        <>
                            <div className="grid grid-cols-3 gap-4">
                                <Field name="year" placeholder="Year" required />
                                <div className="col-span-2"><Field name="title" placeholder="Event Title" required /></div>
                            </div>
                            <textarea name="description" value={formData.description || ''} onChange={e => onChange('description', e.target.value)} placeholder="Description" className="input-field h-24" />
                        </>
                    );
                case 'partners':
                    return (
                        <>
                            <Field name="name" placeholder="Partner Name" required />
                            <Field name="website_url" placeholder="Website URL" />
                            <ImageUpload name="logo_url" label="Partner Logo" />
                        </>
                    );
                case 'achievements':
                    return (
                        <>
                            <Field name="title" placeholder="Achievement Title" required />
                            <div className="grid grid-cols-2 gap-4">
                                <Field name="icon" placeholder="Icon Name (e.g. award)" />
                                <Field name="link" placeholder="Link URL" />
                            </div>
                            <textarea name="description" value={formData.description || ''} onChange={e => onChange('description', e.target.value)} placeholder="Description" className="input-field h-24" />
                        </>
                    );
                case 'events':
                    return (
                        <>
                            <Field name="title" placeholder="Event Title" required />
                            <Field name="event_date" type="date" />
                            <Field name="location" placeholder="Location" />
                            <textarea name="description" value={formData.description || ''} onChange={e => onChange('description', e.target.value)} placeholder="Description" className="input-field h-24" />
                            <Field name="redirect_url" placeholder="Registration Link" />
                        </>
                    );
                default:
                    return <div className="text-red-500">Form configuration not found for {view}</div>;
            }
        };

        const EditModal = ({ isOpen, onClose, view, item, onSave, client, galleryProps }) => {
            if (!isOpen) return null;

            // Form state is managed locally here
            const [formData, setFormData] = useState(item || {});
            const [saving, setSaving] = useState(false);

            useEffect(() => { setFormData(item || {}); }, [item]);

            const handleChange = (key, value) => setFormData(prev => ({ ...prev, [key]: value }));

            const handleFileSelect = (key, file, previewUrl) => {
                setFormData(prev => ({
                    ...prev,
                    [key]: previewUrl,
                    [`_${key.replace('url', 'file')}`]: file // Store file object with underscore prefix
                }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSaving(true);
                await onSave(formData);
                setSaving(false);
            };

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-gray-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col border border-gray-800">
                        {/* Modal Header */}
                        <div className="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-900">
                            <h3 className="text-xl font-bold text-white capitalize">{formData.id ? 'Edit' : 'Create'} {view}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white transition"><Icon name="x" /></button>
                        </div>

                        {/* Modal Body */}
                        <div className="p-6 overflow-y-auto custom-scrollbar bg-gray-900/50 flex-1">
                            <form id="editForm" onSubmit={handleSubmit} className="grid grid-cols-1 gap-5">
                                <FormFields
                                    view={view}
                                    formData={formData}
                                    onChange={handleChange}
                                    onFileSelect={handleFileSelect}
                                />

                                <div className="flex justify-end pt-4 border-t border-gray-800">
                                    <button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                        {saving ? <Loader /> : <Icon name="save" size={18} />}
                                        {saving ? 'Saving...' : 'Save Details'}
                                    </button>
                                </div>
                            </form>

                            {/* Media Manager Integration */}
                            {(view === 'projects' || view === 'events' || view === 'gallery') && (
                                <MediaManager
                                    entityType={view === 'gallery' ? 'GALLERY' : view.slice(0, -1).toUpperCase()}
                                    entityId={formData.id}
                                    supabase={client}
                                    {...galleryProps}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // MAIN LAYOUT COMPONENTS
        // ==========================================

        const Sidebar = ({ currentView, onChangeView, onLogout }) => {
            const NavItem = ({ id, label, icon }) => (
                <button
                    onClick={() => onChangeView(id)}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${currentView === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
                >
                    <Icon name={icon} size={18} />
                    <span className="font-medium capitalize">{label || id}</span>
                </button>
            );

            return (
                <aside className="w-64 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0 z-20">
                    <div className="p-6 border-b border-gray-800">
                        <h1 className="text-xl font-bold text-white tracking-wide">ADMIN PANEL</h1>
                    </div>
                    <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <NavItem id="dashboard" icon="layout-dashboard" />

                        <div className="pt-4 pb-2 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Content</div>
                        <NavItem id="projects" icon="folder" />
                        <NavItem id="events" icon="calendar" />
                        <NavItem id="timeline" icon="clock" />
                        <NavItem id="achievements" icon="award" />
                        <NavItem id="partners" icon="briefcase" />

                        <div className="pt-4 pb-2 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">People & Gallery</div>
                        <NavItem id="team" icon="users" />
                        <NavItem id="alumni" icon="graduation-cap" />
                        <NavItem id="gallery" icon="image" />

                        <div className="pt-4 pb-2 px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Management</div>
                        <NavItem id="applications" icon="file-text" />
                    </nav>
                    <div className="p-4 border-t border-gray-800">
                        <button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-3 text-red-400 hover:bg-red-900/10 hover:text-red-300 rounded-lg transition">
                            <Icon name="log-out" size={18} /> Logout
                        </button>
                    </div>
                </aside>
            );
        };

        const Header = ({ view, searchTerm, onSearchChange, onAdd, onReorder }) => (
            <header className="h-16 border-b border-gray-800 flex items-center justify-between px-8 bg-gray-900/50 backdrop-blur sticky top-0 z-10">
                <h2 className="text-xl font-bold capitalize text-white flex items-center gap-3">
                    {view}
                    {ORDERABLE_VIEWS.includes(view) && <span className="text-xs bg-gray-800 text-gray-400 px-2 py-0.5 rounded border border-gray-700 font-normal">Orderable</span>}
                </h2>

                {view !== 'dashboard' && (
                    <div className="flex items-center gap-3">
                        <div className="relative group">
                            <Icon name="search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-blue-500 transition-colors" />
                            <input
                                type="text"
                                placeholder="Search records..."
                                value={searchTerm}
                                onChange={(e) => onSearchChange(e.target.value)}
                                className="bg-gray-800 border border-gray-700 text-sm text-white rounded-lg pl-9 pr-4 py-2 focus:border-blue-500 outline-none w-64 transition-all focus:w-72"
                            />
                        </div>

                        {ORDERABLE_VIEWS.includes(view) && (
                            <button onClick={onReorder} className="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 border border-gray-700 transition shadow-sm">
                                <Icon name="arrow-down-up" size={16} /> Reorder
                            </button>
                        )}

                        {view !== 'applications' && (
                            <button onClick={onAdd} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition hover:scale-105 active:scale-95">
                                <Icon name="plus" size={16} /> Add New
                            </button>
                        )}
                    </div>
                )}
            </header>
        );

        // ==========================================
        // MAIN APP LOGIC
        // ==========================================

        const App = () => {
            // -- State --
            const [client, setClient] = useState(null);
            const [view, setView] = useState('dashboard');
            const [toast, setToast] = useState(null);
            const [loading, setLoading] = useState(false);
            const [tableData, setTableData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');

            // Modals
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isReorderOpen, setIsReorderOpen] = useState(false);
            const [editingItem, setEditingItem] = useState({});

            // Gallery State
            const [galleryItems, setGalleryItems] = useState([]);
            const [galleryDeletedIds, setGalleryDeletedIds] = useState([]);

            // Dashboard State
            const [enrollmentStatus, setEnrollmentStatus] = useState(false);
            const [dashboardStats, setDashboardStats] = useState({});

            // -- Effects --

            // Init Auth from Session
            useEffect(() => {
                const storedUrl = sessionStorage.getItem('sb_url');
                const storedKey = sessionStorage.getItem('sb_key');
                if (storedUrl && storedKey) handleLogin(storedUrl, storedKey);
            }, []);

            // Fetch Data on View Change
            useEffect(() => {
                if (client) fetchData();
                setSearchTerm('');
            }, [client, view]);

            // -- Handlers --

            const handleLogin = (url, key) => {
                try {
                    const sb = createClient(url, key);
                    setClient(sb);
                    sessionStorage.setItem('sb_url', url);
                    sessionStorage.setItem('sb_key', key);
                } catch (e) {
                    alert("Failed to initialize Supabase client.");
                }
            };

            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            // Generic File Upload
            const uploadFile = async (file, prefix) => {
                const fileExt = file.name.split('.').pop();
                const fileName = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const { error } = await client.storage.from(BUCKET_NAME).upload(fileName, file);
                if (error) throw error;
                const { data } = client.storage.from(BUCKET_NAME).getPublicUrl(fileName);
                return data.publicUrl;
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    if (view === 'dashboard') {
                        // Fetch Config
                        const { data: config } = await client.from('site_config').select('*').eq('key_name', 'enrollment_status').single();
                        if (config) setEnrollmentStatus(config.value_boolean);
                        else await client.from('site_config').insert([{ key_name: 'enrollment_status', value_boolean: false }]);

                        // Fetch Counts
                        const tables = ['projects', 'events', 'team_members', 'applications'];
                        const stats = {};
                        await Promise.all(tables.map(async (t) => {
                            const { count } = await client.from(t).select('*', { count: 'exact', head: true });
                            stats[t] = count || 0;
                        }));
                        setDashboardStats(stats);
                    } else {
                        const table = TABLE_MAP[view];
                        if (!table) throw new Error("Unknown table");

                        const query = client.from(table).select('*');

                        // Default Sorting Logic
                        if (ORDERABLE_VIEWS.includes(view)) {
                            query.order('sort_order', { ascending: true });
                        } else if (view === 'applications') {
                            query.order('created_at', { ascending: false });
                        } else {
                            query.order('id', { ascending: false });
                        }

                        const { data, error } = await query;
                        if (error) throw error;
                        setTableData(data || []);
                    }
                } catch (e) {
                    showToast(e.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleSaveItem = async (formData) => {
                const table = TABLE_MAP[view];
                const payload = { ...formData };

                // Cleanup temp fields
                delete payload.id;
                const imageFile = payload._image_file; delete payload._image_file;
                const logoFile = payload._logo_file; delete payload._logo_file;

                try {
                    // Upload Files if present
                    if (imageFile) payload.image_url = await uploadFile(imageFile, view);
                    if (logoFile) payload.logo_url = await uploadFile(logoFile, 'partners');

                    // Data Cleaning
                    if (view === 'projects') {
                        if (typeof payload.technologies === 'string') payload.technologies = payload.technologies.split(',').map(s => s.trim()).filter(s => s);
                        if (typeof payload.contributors === 'string') payload.contributors = payload.contributors.split(',').map(s => s.trim()).filter(s => s);
                    }

                    // Assign Sort Order for new items
                    if (!formData.id && ORDERABLE_VIEWS.includes(view)) {
                        payload.sort_order = 9999;
                    }

                    // Database Upsert
                    let savedId = formData.id;
                    if (formData.id) {
                        const { data, error } = await client.from(table).update(payload).eq('id', formData.id).select();
                        if (error) throw error;
                        savedId = data[0].id;
                    } else {
                        const { data, error } = await client.from(table).insert([payload]).select();
                        if (error) throw error;
                        savedId = data[0].id;
                    }

                    // Handle Media Gallery (Complex Logic)
                    if (['projects', 'events', 'gallery'].includes(view)) {
                        const entityType = view === 'gallery' ? 'GALLERY' : view.slice(0, -1).toUpperCase();

                        // Delete removed images
                        if (galleryDeletedIds.length > 0) await client.from('media_gallery').delete().in('id', galleryDeletedIds);

                        // Upload new gallery images
                        const processedItems = await Promise.all(galleryItems.map(async (item) => {
                            let finalUrl = item.image_url;
                            if (item.file) finalUrl = await uploadFile(item.file, entityType.toLowerCase());
                            return {
                                entity_type: entityType,
                                entity_id: savedId,
                                image_url: finalUrl,
                                is_primary: item.is_primary,
                                media_type: item.media_type || 'IMAGE',
                                ...(item.id ? { id: item.id } : {}) // Keep ID for existing
                            };
                        }));

                        if (processedItems.length > 0) await client.from('media_gallery').upsert(processedItems);
                    }

                    showToast('Saved Successfully');
                    setIsModalOpen(false);
                    fetchData();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            };

            const handleDelete = async (id) => {
                if (!confirm("Permanently delete this record? This cannot be undone.")) return;
                try {
                    const { error } = await client.from(TABLE_MAP[view]).delete().eq('id', id);
                    if (error) throw error;
                    fetchData();
                    showToast('Deleted Successfully');
                } catch (err) { showToast("Delete failed: " + err.message, 'error'); }
            };

            const handleReorderSave = async (newList) => {
                try {
                    const updates = newList.map((item, index) => ({ id: item.id, sort_order: index }));
                    // Sequential update (Supabase doesn't support bulk update easily via JS client for different values)
                    // Optimization: Could use an RPC function, but this is fine for small lists
                    await Promise.all(updates.map(u => client.from(TABLE_MAP[view]).update({ sort_order: u.sort_order }).eq('id', u.id)));

                    showToast('Order Updated');
                    setIsReorderOpen(false);
                    fetchData();
                } catch (e) { showToast("Error saving order", 'error'); }
            };

            const toggleEnrollment = async () => {
                try {
                    const newValue = !enrollmentStatus;
                    const { error } = await client.from('site_config').update({ value_boolean: newValue }).eq('key_name', 'enrollment_status');
                    if (error) throw error;
                    setEnrollmentStatus(newValue);
                    showToast(newValue ? "Enrollment Started" : "Enrollment Stopped");
                } catch (e) { showToast("Error updating status", 'error'); }
            };

            const filteredData = useMemo(() => {
                if (!searchTerm) return tableData;
                return tableData.filter(item => Object.values(item).some(val => val && String(val).toLowerCase().includes(searchTerm.toLowerCase())));
            }, [tableData, searchTerm]);

            // Helper to determine table columns
            const getColumns = () => {
                switch (view) {
                    case 'projects': return [{ key: 'title', label: 'Title' }, { key: 'category', label: 'Category' }, { key: 'technologies', label: 'Tech', type: 'array' }];
                    case 'team': return [{ key: 'image_url', label: 'Photo', type: 'image' }, { key: 'name', label: 'Name' }, { key: 'team_role', label: 'Role' }];
                    case 'alumni': return [{ key: 'image_url', label: 'Photo', type: 'image' }, { key: 'name', label: 'Name' }, { key: 'graduation_year', label: 'Class of' }, { key: 'job_title', label: 'Current Role' }];
                    case 'applications': return [{ key: 'name', label: 'Student Name' }, { key: 'email', label: 'Email' }, { key: 'branch', label: 'Branch' }, { key: 'year', label: 'Year' }];
                    case 'gallery': return [{ key: 'title', label: 'Album' }, { key: 'event_date', label: 'Date' }];
                    case 'partners': return [{ key: 'logo_url', label: 'Logo', type: 'image' }, { key: 'name', label: 'Partner' }];
                    case 'timeline': return [{ key: 'year', label: 'Year' }, { key: 'title', label: 'Event' }];
                    default: return [{ key: 'id', label: 'ID' }, { key: 'title', label: 'Title' }];
                }
            };

            if (!client) return <Login onLogin={handleLogin} />;

            return (
                <div className="flex h-screen overflow-hidden bg-gray-950">
                    <Sidebar currentView={view} onChangeView={setView} onLogout={() => { sessionStorage.clear(); window.location.reload(); }} />

                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        <Header
                            view={view}
                            searchTerm={searchTerm}
                            onSearchChange={setSearchTerm}
                            onAdd={() => { setEditingItem({}); setGalleryItems([]); setGalleryDeletedIds([]); setIsModalOpen(true); }}
                            onReorder={() => setIsReorderOpen(true)}
                        />

                        <div className="flex-1 overflow-auto p-8 custom-scrollbar">
                            {view === 'dashboard' ? (
                                <Dashboard stats={dashboardStats} enrollmentStatus={enrollmentStatus} onToggleEnrollment={toggleEnrollment} />
                            ) : (
                                loading ? <div className="flex justify-center pt-20"><Loader /></div> :
                                    <DataTable
                                        columns={getColumns()}
                                        data={filteredData}
                                        onEdit={view === 'applications' ? null : (item) => { setEditingItem(item); setGalleryItems([]); setGalleryDeletedIds([]); setIsModalOpen(true); }}
                                        onDelete={handleDelete}
                                    />
                            )}
                        </div>
                    </main>

                    {/* Modals & Overlays */}
                    <ReorderModal
                        isOpen={isReorderOpen}
                        onClose={() => setIsReorderOpen(false)}
                        items={tableData}
                        onSave={handleReorderSave}
                        title={view}
                    />

                    <EditModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        view={view}
                        item={editingItem}
                        onSave={handleSaveItem}
                        client={client}
                        galleryProps={{ items: galleryItems, onItemsChange: setGalleryItems, onDeletedIdsChange: (id) => setGalleryDeletedIds(prev => [...prev, id]) }}
                    />

                    {toast && (
                        <div className={`fixed bottom-6 right-6 px-6 py-3 rounded shadow-xl text-white font-bold z-50 slide-in flex items-center gap-2 ${toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
                            <Icon name={toast.type === 'error' ? 'alert-circle' : 'check-circle'} size={20} />
                            {toast.msg}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>